<html>
    <head>
<meta charset="utf-8"/>
<meta name=”apple-mobile-web-app-capable” content=”yes”>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel=stylesheet href="https://codemirror.net/3/doc/docs.css">
<link rel="stylesheet" href="https://codemirror.net/3/lib/codemirror.css">
<link rel="stylesheet" href="https://codemirror.net/3/theme/ambiance.css">
<link rel="stylesheet" href="addons/hover/text-hover.css">
<script src="https://codemirror.net/3/lib/codemirror.js"></script>
<script src="https://codemirror.net/3/addon/edit/matchbrackets.js"></script>
<script src="https://codemirror.net/3/addon/comment/comment.js"></script>
<script src="https://codemirror.net/3/addon/comment/continuecomment.js"></script>
<script src="https://codemirror.net/3/mode/haskell/haskell.js"></script>
<script src="addons/hover/text-hover.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.js"></script>
<style type="text/css">.CodeMirror {border-top: 1px solid black; border-bottom: 1px solid black;}</style>
<style>

.CodeMirror-lint-mark {
  background-position: left bottom;
  background-repeat: repeat-x;
}

.CodeMirror-lint-mark-error {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg==");
}

.splitter {
    width: 100%;
    height: 96%;
    display: flex;
}

#separator {
    cursor: col-resize;
    background-color: #aaa;
    background-repeat: no-repeat;
    background-position: center;
    width: 10px;
    height: 96%;

    /* Prevent the browser's built-in drag from interfering */
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

#first {
    width:50%;
    height: 96%;
    min-width: 10px;
}

#second {
    width: 50%;
    height: 96%;
    min-width: 10px;
}

#head {
    width: 100%;
    height: 5%;
}

.CodeMirror { height: 100%; }

</style></head><body style="background-color: black;">

<div id="head" class="w3-bar w3-black" style="display: flex; height:38px">
        <div class="w3-bar-item" style="flex-grow: 1;">Junior</div>
        <div class="w3-bar-item"><p id="bench"></p></div>
        <div class="w3-bar-item" style="flex-grow: 0;">
            <input id="autoRunCheckBoxInterpreter" type="checkbox">auto run interp</input>
        </div>
        <div class="w3-bar-item" style="flex-grow: 0;">
            <input id="autoRunCheckBoxJavaScript" type="checkbox">auto run js</input>
        </div>
        <div style="text-align: right; white-space: nowrap;">
            <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event, 'Typed')">Typed</button>
            <button class="w3-bar-item w3-button tablink"onclick="openTab(event, 'Compiled')">Compiled</button>
            <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'Output')">Output Interp</button>
            <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'CompiledJs')">Compiled Js</button>
            <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'OutputJs')">Output Js</button>
        </div>
</div>

<div class="splitter">
    <div id="first">
        <textarea id="code" name="code"></textarea>
    </div>
    <div id="separator" ></div>
    <div id="second" style="background-color: black;">
        <textarea id="types" name="types"></textarea>
        <textarea id="compiled" name="compiled"></textarea>
        <textarea id="out" name="out"></textarea>
        <canvas id="canvas" style="display: none;"></canvas>
        <textarea id="compiledJs" name="compiledJs"></textarea>
        <textarea id="outputJs" name="outputJs"></textarea>
    </div>
</div>

<script>
var currentTabName = "";
function activatePanel(name) {
   clearPanels();
   if (name == "Typed") {
    editorTypes.getWrapperElement().style.display = "block"; 
    compileTo("/type", editor.getValue(), editorTypes);  
   }
   if (name == "Compiled") {
    editorCompiled.getWrapperElement().style.display = "block";
    compileTo("/compile", editor.getValue(), editorCompiled);
   }
   if (name == "Output") { 
    editorOutput.getWrapperElement().style.display = "block";
   }
   if (name == "CompiledJs") { 
    editorCompiledJs.getWrapperElement().style.display = "block";
    compileToJs();
   }
   if (name == "OutputJs") { 
    compileToJs();
    editorOutputJs.getWrapperElement().style.display = "block";
   }
   currentTabName = name;
}

function clearPanels() {
  var canvas = document.getElementById('canvas');
  canvas.style.display = "none";
  editorOutput.getWrapperElement().style.display = "none";
  editorCompiled.getWrapperElement().style.display = "none";
  editorTypes.getWrapperElement().style.display = "none";
  editorCompiledJs.getWrapperElement().style.display = "none";
  editorOutputJs.getWrapperElement().style.display = "none";
}

function openTab(evt, tabName) {
  var i, tablinks;
  activatePanel(tabName);
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
  }
  evt.currentTarget.className += " w3-red";
}

// A function is used for dragging and moving
function dragElement(element, direction)
{
    var   md; // remember mouse down info
    const first  = document.getElementById("first");
    const second = document.getElementById("second");

    element.onmousedown = onMouseDown;

    function onMouseDown(e)
    {
        //console.log("mouse down: " + e.clientX);
        md = {e,
              offsetLeft:  element.offsetLeft,
              offsetTop:   element.offsetTop,
              firstWidth:  first.offsetWidth,
              secondWidth: second.offsetWidth
             };

        document.onmousemove = onMouseMove;
        document.onmouseup = () => {
            //console.log("mouse up");
            document.onmousemove = document.onmouseup = null;
        }
    }

    function onMouseMove(e)
    {
        //console.log("mouse move: " + e.clientX);
        var delta = {x: e.clientX - md.e.clientX,
                     y: e.clientY - md.e.clientY};

        if (direction === "H" ) // Horizontal
        {
            // Prevent negative-sized elements
            delta.x = Math.min(Math.max(delta.x, -md.firstWidth),
                       md.secondWidth);

            element.style.left = md.offsetLeft + delta.x + "px";
            first.style.width = (md.firstWidth + delta.x) + "px";
            second.style.width = (md.secondWidth - delta.x) + "px";
        }
    }
}


dragElement( document.getElementById("separator"), "H" );

function showTooltip(e, content) {
    var tt = document.createElement("div");
    tt.className = "CodeMirror-hover-tooltip";
    if (typeof content == "string") {
        content = document.createTextNode(content);
    }
    tt.appendChild(content);
    document.body.appendChild(tt);

    function position(e) {
        tt.style.top = Math.max(0, e.top - tt.offsetHeight - 5) + "px";
        tt.style.left = (e.left + 5) + "px";
    }
    position(e);
    if (tt.style.opacity != null)
        tt.style.opacity = 1;
    return tt;
}

var activeTooltip = null;
var removeTT = function(cm) { removeTooltip(cm, activeTooltip); }

function removeTooltip(editor, elt) {
    editor.off("scroll", removeTT);
    editor.off("mousedown", removeTT);
    if (elt.parentNode)
        elt.parentNode.removeChild(elt);
}

var dictionary = {};
const keyMap = {
    "Shift-Alt-=": function (cm) {
        if (activeTooltip != null) removeTooltip(cm, activeTooltip);

        const cursor = cm.getCursor();
        const token = cm.getTokenAt(cursor);
        const start = token.start + 1;
        const end = cursor.ch;
        const line = cursor.line + 1;
        const currentWord = token.string;

        const key = "(" + line + "," + start + "," + currentWord.length + "," + currentWord + ")"; 
        var ret = dictionary[key];       
        activeTooltip = showTooltip(cm.cursorCoords(true), ret.ty);
        cm.on("scroll", removeTT);
        cm.on("mousedown", removeTT);
    },
    "Ctrl-.": function (cm) {
        if (currentTabName == "Output") run();
        if (currentTabName == "OutputJs") compileToJs();
    },
    "Ctrl-/": function(cm) {
      CodeMirror.commands.toggleComment(cm, { commentBlankLines:true, fillLines: true });
    },
    "Tab": editor => {
      if (editor.somethingSelected()) {
        editor.indentSelection("add");
      } else {
        editor.replaceSelection(editor.getOption("indentWithTabs")? "\t" :
          Array(editor.getOption("indentUnit") + 1).join(" "), "end", "+input");
      }
    },
    "Ctrl-D": editor => {
      editor.operation(() => {
        var current_cursor = editor.doc.getCursor();
        var line_content = editor.doc.getLine(current_cursor.line);
        CodeMirror.commands.goLineEnd(editor);
        CodeMirror.commands.newlineAndIndent(editor);
        CodeMirror.commands.goLineLeft(editor);
        editor.doc.replaceSelection(line_content);
        editor.doc.setCursor(current_cursor.line + 1, current_cursor.ch);
        editor.scrollIntoView();
      })
    }    
}


      var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        matchBrackets: true,
        extraKeys: keyMap,
        theme: "ambiance"
      });

      var editorTypes = CodeMirror.fromTextArea(document.getElementById("types"), {
        lineNumbers: true,
        matchBrackets: true,
        theme: "ambiance"
      });

      var editorCompiled = CodeMirror.fromTextArea(document.getElementById("compiled"), {
        lineNumbers: true,
        matchBrackets: true,
        theme: "ambiance"
      });

      var editorOutput = CodeMirror.fromTextArea(document.getElementById("out"), {
        lineNumbers: true,
        matchBrackets: true,
        theme: "ambiance"
      });

      var editorCompiledJs = CodeMirror.fromTextArea(document.getElementById("compiledJs"), {
        lineNumbers: true,
        matchBrackets: true,
        theme: "ambiance"
      });

      var editorOutputJs = CodeMirror.fromTextArea(document.getElementById("outputJs"), {
        lineNumbers: true,
        matchBrackets: true,
        theme: "ambiance"
      });

      const markers = []; 

      window.onload = function() {

      var canvas = document.getElementById('canvas');
      canvas.style.zIndex = "2";
      canvas.style.width  = '100%';
      canvas.style.height = '100%';
      var ctx = canvas.getContext('2d');
      clearPanels();
      activatePanel("Typed")
     
      editor.on("change", function () {
        var code = editor.getValue();
        editorOutputJs.setValue("");
        editorCompiledJs.setValue("");
        editorOutput.setValue("");
        editorTypes.setValue("");
        editorCompiled.setValue("");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
  
        var autoRun = document.getElementById("autoRunCheckBoxInterpreter");
        if (autoRun.checked) run();
        compileTo("/type", code, editorTypes);
        compileTo("/compile", code, editorCompiled);
        compileToJs();
      });
    };

    function compileTo(path, code, cm) {
        fetch(path, { method:'POST', body: code})
        .then(res => {
	      // Handle response
          res.text().then(function (text) { 
            if (!text.includes("EOF")) {
                markers.forEach(marker => marker.clear());
                const json = JSON.parse(text);
                if (json[0] != undefined) {
                    cm.setValue(json[0]);
                }
                if (json[1] != undefined && Array.isArray(json[1])) {
                    const obj = json[1];
                    dictionary = {};
                    obj.forEach(sym => {
                        dictionary["(" +
                                   sym.name.loc.line + "," + 
                                   sym.name.loc.column + "," + 
                                   sym.name.loc.len + "," +
                                   sym.name.txt + 
                                   ")"] = sym;
                    });   
                    cm.setValue(json[0]);
                } else {
                    const obj = json;
                    cm.setValue(obj.txt);
                    const loc = obj.loc;
                    if (loc != null) {
                    const from = { line: loc.line - 1, ch: loc.column - 1 };
                    const to = { line: loc.line - 1, ch: loc.column + loc.len - 1 };
                    markers.push(editor.markText(from, to, { className: 'CodeMirror-lint-mark CodeMirror-lint-mark-error', title: obj.txt}));
                    }
                }
            }
          });
          
        })
        .catch(err => {
	      // Handle error
	      console.log('Error message: ', err);
        });
    }

    function run() {
      if (currentTabName != "Output") return;
        var code = editor.getValue();
        fetch("run/", { method:'POST', body: code})
        .then(res => {
	      // Handle response
          res.text().then(function (text) { 
            if (!text.includes("EOF")) {
                try {
                var canvas = document.getElementById('canvas');
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const json = JSON.parse(text);
                if (json[0] != undefined && json[0].startsWith("{\"image\":")) {
                    try {
                    var parsedRet = JSON.parse(json[0].replaceAll("(", "[").replaceAll(")", "]"));
                    var imageData = parsedRet["image"];
                    if (Array.isArray(imageData) && Array.isArray(imageData[0])) {
                    clearPanels();
                    canvas.width  = imageData.length;
                    canvas.height = imageData.length; 
                    canvas.style.display = "block";
                        for(var y = 0; y < imageData.length; y++){
                            for(var x = 0; x < imageData[y].length; x++){
                               ctx.fillStyle = `rgb(${imageData[y][x][0]}, ${imageData[y][x][1]}, ${imageData[y][x][2]})`;
                               ctx.fillRect( x, y, 1, 1 );
                            }
                        }
                    } else {
                        editorOutput.getWrapperElement().style.display = "block";
                        editorOutput.setValue(json[0]);
                    }
                } catch (e) {
                    editorOutput.getWrapperElement().style.display = "block";
                    editorOutput.setValue(json[0]);
                }
               } else {
                editorOutput.getWrapperElement().style.display = "block"; 
                editorOutput.setValue(json[0]);
               }
             } catch (e) {
                editorOutput.getWrapperElement().style.display = "block";
                editorOutput.setValue(text);
             }
            } 
          });       
        })
        .catch(err => {
	      // Handle error
	      console.log('Error message: ', err);
        });
    }

    function msToTime(s) {
      // Pad to 2 or 3 digits, default is 2
      function pad(n, z) {
        z = z || 2;
        return ('00' + n).slice(-z);
      }

      var ms = s % 1000;
      s = (s - ms) / 1000;   
      var secs = s % 60;
      s = (s - secs) / 60;
      var mins = s % 60;
      var hrs = (s - mins) / 60;

      return pad(hrs) + ':' + pad(mins) + ':' + pad(secs) + '.' + pad(ms, 3);
      }

    function runJs(jsCode) {
      if (currentTabName != "OutputJs") return;
      editorOutputJs.getWrapperElement().style.display = "block";
      fetch("libJs/", { method: 'GET' })
      .then(res => { 
         // Handle response
         res.text().then(function (libCodeJson) { 
          try {
            var script = "(function() {\n\n" + JSON.parse(libCodeJson) + 
                                      "\n\n" + jsCode.replace("const main = ", "return ") + 
                                      "\n\n})();"
            const t0 = performance.now();
            var ret = JSON.stringify(eval(script));
            const t1 = performance.now();
            document.getElementById("bench").innerText = "Running JS took " + msToTime(t1 - t0);
            editorOutputJs.setValue(ret);
          } catch (e) {
            var canvas = document.getElementById('canvas');
            canvas.style.display = "none";
            editorOutputJs.setValue("" + e);
          }
        });
      });
    }

    function compileToJs() {
        var code = editor.getValue();
        fetch("compileToJs/", { method:'POST', body: code})
        .then(res => {
	      // Handle response
          res.text().then(function (text) { 
            if (!text.includes("EOF")) {
                try {
                   const json = JSON.parse(text);
                   if (json[0] != undefined) {
                     var autoRun = document.getElementById("autoRunCheckBoxJavaScript");
                     if (autoRun.checked) runJs(json[0]);
                     editorCompiledJs.setValue(
                        window.js_beautify(json[0], window.js_beautify.defaultOptions())
                     );
                   } else 
                     editorCompiledJs.setValue(text);
                } catch (e) {
                     editorCompiledJs.setValue(text);
                }
            } 
          });       
        })
        .catch(err => {
	      // Handle error
	      console.log('Error message: ', err);
        });
    }
    


</script></body></html>